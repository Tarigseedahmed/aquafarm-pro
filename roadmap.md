# خطة تفصيلية ومُرحّلة لإنشاء منصة سحابية متعددة الشركات (SaaS)

> **هدف المشروع:** نظام سحابي (SaaS) لإدارة ومحاسبة مزارع الأسماك متعدّد المستأجرين (Multi-Tenant), يدعم اللغة العربية والإنجليزية، يلتزم بالمعايير الدولية والعربية للمحاسبة، ويعمل على بنية قابلة للتوسع، آمنة، وقابلة للتكامل مع أجهزة الاستشعار (IoT).

---

## ملخص تنفيذي

هذه الخطة مُفصّلة على مراحل تنفيذية قابلة للتطبيق مباشرة دون الحاجة لمقترحات/تحسينات إضافية أثناء التنفيذ. تغطي المتطلبات الوظيفية، المعمارية التقنية، بيانات التصميم، خطة تطوير مفصّلة بالمراحل والمهام، اختبارات، نشر، تشغيل وصيانة، معيّنات الأمان والامتثال، وتقدير فريق العمل والموارد.

---

## 1. المتطلبات الأساسية (Scope)

### 1.1 وظائف أساسية مطلوبة

* إدارة المستخدمين والصلاحيات (RBAC).
* إدارة الشركات (Tenants): بيانات الكيان، إعدادات محلية لكل شركة.
* إدارة الأحواض/الأقفاص والدورات الإنتاجية.
* تسجيل ومتابعة أعداد الأسماك، متوسط الأوزان، نمو، نفوق.
* إدارة الأعلاف: مخزون، استهلاك، توصيات تغذية.
* متابعة جودة المياه: قياسات pH، DO، حرارة، أمونيا... (يدعم إدخال يدوي أو من أجهزة IoT).
* إدارة المخزون (أعلاف، أدوية، مستلزمات).
* نظام محاسبي كامل: دفتر يومية، قيود محاسبية، فواتير مشتريات ومبيعات، كشف حساب موردين/عملاء، سجلات أصول، التقارير المالية (قائمة دخل، ميزانية، بيان التدفقات النقدية) متوافق مع IFRS ومتطلبات المحاسبة العربية.
* نظام تقارير وتحليلات قابلة للتخصيص (BI).
* تنبيهات وإشعارات (بريد، SMS، داخل التطبيق).
* واجهة متعددة اللغات (ع/إن) وRTL للعربية.
* واجهة ويب + تطبيق موبايل (عرضي/إدخال بيانات ميدانية).
* APIs عامة (REST/GraphQL) للتكامل مع أنظمة خارجية وأجهزة IoT.

### 1.2 متطلبات غير وظيفية

* تعدد مستأجرين (عزل البيانات لكل شركة).
* أداء: استجابة أقل من 300 مللي ثانية لطلبات CRUD القياسية.
* توافر: SLO 99.9% بعد الانتشار.
* أمان: تشفير نقل وراحة البيانات، إدارة مفاتيح، حماية ضد هجمات شائعة (OWASP Top10).
* نسخ احتياطي واسترداد كلي/جزئي.
* قابلية التوسع أفقياً/عمودياً.

---

## 2. اختيارات المعمارية التقنية

### 2.1 ملخص المعمارية العامة

* **نمط:** SaaS - Multi-Tenant (اختيار نموذج تخزين: قاعدة بيانات مفصولة لكل Tenant أو مخطط واحد مع تمييز TenantId). التوصية: **قاعدة بيانات مشتركة مع عمود tenant\_id** للمرونة الاقتصادية ولتبسيط إدارة الموارد، مع إمكانية فصل قواعد بيانات للتنسنز الكبيرة (Hybrid approach).
* **واجهات:** Frontend React مع Next.js (SSR) أو Vue + Nuxt، يدعمان i18n وRTL.
* **Backend:** Node.js (TypeScript) مع NestJS (يوفر هيكلية واضحة، modules, guards, interceptors). بديل: Django (Python) إن كان فريقك يفضل بايثون.
* **قاعدة البيانات:** PostgreSQL (ACID، دعم JSONB، قدرات استعلام قوية).
* **Caching:** Redis (جلسات، قائمة انتظار، قفل متسلسل، بيانات مؤقتة).
* **Storage:** S3-compatible (AWS S3 أو DigitalOcean Spaces) للملفات والمرفقات.
* **Mobile:** React Native أو Flutter (لتطبيق جمع بيانات ميدانية، يعمل أوفلاين ثم يزامن).
* **Message Broker / Event Bus:** Kafka أو RabbitMQ (لتعاملات التغذية، إشعارات، ETL).
* **API:** REST + GraphQL (GraphQL لواجهات البيانات المرنة وREST للبوابات السهلة).
* **CI/CD:** GitHub Actions / GitLab CI لنشر آلي (build, test, security scans, deploy).
* **Infra:** Kubernetes (EKS/GKE/AKS أو k8s على VPS) مع Helm charts.
* **Observability:** Prometheus + Grafana + Loki (logs) + OpenTelemetry.

### 2.2 نموذج التعددية (Multi-Tenancy)

* **Auth & Tenant Context:** كل طلب يحمل JWT يحتوي على tenant\_id، أو يتم جلب tenant من الدومين الفرعي (company.example.com).
* **عزل البيانات:** عمود tenant\_id في الجداول الرئيسية (مؤشرات وفهارس على tenant\_id).
* **Configuration per tenant:** جدول settings مرتبط بالـ tenant لتخصيص سياسات التغذية، وحدات العملة والتقارير.

### 2.3 نموذج المحاسبة

* نظام قيود مزدوجة (Double-entry bookkeeping).
* إعداد خطة حسابية قابلة للتعديل لكل Tenant (Chart of Accounts) لكن مع قالب افتراضي مطابق للمعايير الدولية والعربية.
* واجهات لإنشاء قيود يدوية، وقواعد تلقائية لإنشاء قيود من الفواتير والمشتريات والرواتب.

---

## 3. نموذج البيانات (مخطط عالي المستوى)

> ملاحظة: هذا للمخطط المفاهيمي؛ ستحصل على ERD مفصل ضمن مرحلة التصميم.

* Tenants (id, name, settings, billing\_info, created\_at)
* Users (id, tenant\_id, name, email, role\_id, locale, password\_hash)
* Roles (id, tenant\_id, name, permissions)
* Ponds/Tanks (id, tenant\_id, code, name, capacity, location, notes)
* ProductionCycles (id, pond\_id, start\_date, end\_date, species, target\_weight)
* FishBatchMeasurements (id, cycle\_id, date, avg\_weight, total\_count, mortality)
* Feeds (id, tenant\_id, sku, stock\_qty, usage\_logs)
* InventoryTransactions (id, tenant\_id, item\_id, qty, type, ref)
* WaterQualityReadings (id, pond\_id, timestamp, ph, do, ammonia, temp, source)
* IoTDevices (id, tenant\_id, device\_type, last\_seen, config)
* Purchases, Sales, Invoices (linked to Accounting entries)
* Accounting: Accounts, JournalEntries, JournalLines, Ledgers, Assets, FixedAssets
* Notifications, Alerts, AuditLogs

---

## 4. خطة تنفيذ مفصّلة مراحلياً (Milestones + Tasks)

> كل مرحلة تحتوي على وصف، قائمة مهام تفصيلية، مع مُخرجات قابلة للتسليم (Deliverables). الأرقام الزمنية افتراضية ويمكن تعديلها وفق فريق العمل.

### المرحلة 0 — الإعداد والتحضير (التأسيس)

**المدة المقترحة:** 2 أسابيع
**مهام:**

* تكوين فريق المشروع (Product Owner, Project Manager, Lead Architect, Frontend Lead, Backend Lead, DevOps, QA, UX/UI, Accountant/Domain Expert).
* عقد ورش عمل مع أصحاب المصلحة لجمع المتطلبات التفصيلية.
* إعداد المستندات: SRS (Software Requirements Specification)، Definition of Done، CI/CD policy، Security policy.
* إعداد بيئة development: مستودع Git، قالب مخطط المشاريع، قواعد التسمية.

**مخرجات:** وثيقة SRS، خطة مشروع Gantt أساسية، repo جاهز، سياسات أمنية.

---

### المرحلة 1 — التصميم المعماري والتقني + ERD + UX (تصميم تفصيلي)

**المدة المقترحة:** 3 أسابيع
**مهام:**

* تصميم معماري تفصيلي: مكونات النظام، مخططات تفاعل الخدمات، نموذج التعددية، مخطط النشر (K8s).
* ERD مفصل لجميع الكيانات مع العلاقات والفهارس (بالإضافة إلى المخطط للمحاسبة والقيود).
* تعريف API contracts (OpenAPI / GraphQL schema).
* تصميم واجهات UX/UI للشاشات الرئيسية (نموذج تسجيل الدخول، لوحة التحكم، إدارة الأحواض، المحاسبة، التقارير، إعدادات الشركة).
* تعريف سياسة الترميز الدولي والمحلي للعملة/التواريخ (locale handling).
* خطة اختبار أولية (unit, integration, e2e, performance).

**مخرجات:** مخطط معماري، ERD، مواصفات API، ملفات تصميم UI (Figma/Sketch)، وثيقة خطة الاختبار.

---

### المرحلة 2 — البنية الأساسية وCI/CD وDevOps

**المدة المقترحة:** 3 أسابيع (بالتوازي مع بداية التطوير)
**مهام:**

* إعداد Kubernetes cluster (أو Managed K8s).
* إعداد Postgres managed (RDS/GCP SQL) مع شبكات فرعية آمنة.
* إعداد Redis, Message Broker, S3 storage.
* إعداد خط CI/CD (lint, test, build, image scan، deploy إلى staging).
* إعداد مراقبة (Prometheus, Grafana), logging (Loki/ELK) و tracing (OpenTelemetry).
* إعداد سياسات النسخ الاحتياطي والاسترجاع لقاعدة البيانات والملفات.

**مخرجات:** بنية تحتية جاهزة، سكربتات نشر، وثائق الوصول.

---

### المرحلة 3 — تطوير Backend الأساسي (Core Services)

**المدة المقترحة:** 8 أسابيع
**مهام (مقسمة على Sprint 2-5):**

* إعداد مشروع Backend (NestJS + TypeScript) وهيكل الـ modules.
* تنفيذ Auth (OAuth2, JWT) مع RBAC وSSO اختياري.
* Tenant middleware (context injection) + سياسات التحقق.
* CRUD لإدارة Tenants, Users, Roles.
* إدارة الأحواض والدورات الإنتاجية، تسجيل القياسات، مخزون الأعلاف.
* تنفيذ نمط المحاسبة الأساسية: Accounts, JournalEntries, posting engine (قواعد تحويل المستندات إلى قيود).
* إنشاء endpoints للفواتير والمشتريات، وإصدار قيود محاسبية تلقائياً.
* API لـ IoT ingestion (secure webhook / MQTT gateway).
* خدمة إشعارات (email, SMS, in-app) وscheduler للمهام الدورية (cron).

**مخرجات:** Backend تعمل عليه الوظائف الأساسية مع تغطية unit tests 70%+. API documentation (OpenAPI).

---

### المرحلة 4 — تطوير الواجهة الأمامية والتطبيق الميداني

**المدة المقترحة:** 8 أسابيع (بالتوازي)
**مهام:**

* بناء واجهة Web (React + Next.js) للشاشات الرئيسية: Dashboard, Ponds, Production Cycles, Inventory, Accounting, Reports, Settings.
* i18n وRTL (عربي/إنجليزي).
* إنشاء data grid متقدم، فلترة، تصدير CSV/PDF، محرّكات البحث الذكي.
* بناء تطبيق موبايل (React Native / Flutter) لعمليات المزرعة الميدانية: إدخال قياسات، قراءة أجهزة، عمليات الجرد أوفلاين ثم مزامنة.
* تكامل مع APIs الخلفية، إدارة الجلسات، handling للأخطاء.

**مخرجات:** واجهات مستخدم عملانية، تطبيق موبايل تجريبي قادر على العمل أوفلاين.

---

### المرحلة 5 — التكامل مع الأجهزة (IoT) والتقارير المتقدمة (BI)

**المدة المقترحة:** 4 أسابيع
**مهام:**

* إعداد بوابة استلام بيانات IoT (MQTT/HTTPS) مع مراقبة الثقة (device auth).
* نمذجة وتخزين قراءات المياه، ربطها بالأحواض والدورات.
* بناء محرك قواعد تنبيهات (مثلاً: pH خارج المدى، أو زيادة النفوق) مع درجات حرجة.
* تنفيذ تقارير BI: تحليل الربحية لكل دورة/حوض، تكاليف الأعلاف لكل كيلو إنتاج، مؤشرات KPI قابلة للتخصيص.

**مخرجات:** Integration Gateway, لوحة BI وتوليد التقارير قابلة للطباعة والتصدير.

---

### المرحلة 6 — الأمن والامتثال والاختبارات النهائية

**المدة المقترحة:** 3 أسابيع
**مهام:**

* اختبارات اختراق (Penetration Testing) من طرف ثالث.
* مراجعة سياسات التشفير (TLS 1.2+, at-rest encryption باستخدام KMS).
* تدقيق محاسبي: التحقق من صحة القيود، ومطابقة التقارير المحاسبية مع معايير IFRS.
* اختبارات تحميل/performance (تحمل 1000 مستخدم متزامن كأساس، قابل للزيادة حسب الحاجة).
* اختبارات E2E، Accessibility (WCAG 2.1 مستوى AA)، اختبارRTL.

**مخرجات:** تقرير أمان، تقرير أداء، شهادة جاهزية للنشر.

---

### المرحلة 7 — النشر التجريبي (Pilot) والتدريب

**المدة المقترحة:** 4 أسابيع
**مهام:**

* اختيار 2-3 عملاء تجريبيين (مزارع بمقاسات مختلفة).
* نشر بيئة production مصغّرة وإعداد tenant data لعملاء البيليوت.
* تدريب المستخدمين، عمل جلسات جمع ملاحظات، ضبط إعدادات النظام حسب ملاحظات المستخدمين.
* تصحيح العيوب الحرجة وتجهيز وثائق المستخدم ودليل التشغيل.

**مخرجات:** نشر Pilot، تقرير مراجعات المستخدمين، قائمة تحسينات نهائية.

---

### المرحلة 8 — نشر عام وإطلاق (Go-Live)

**المدة المقترحة:** 2 أسابيع
**مهام:**

* تهيئة خطة التسعير (Subscriptions: Free trial, Basic, Pro, Enterprise).
* إعداد بوابة الدفع (Stripe/Checkout) وإصدار فواتير دورية.
* نشر production كامل، إعداد مراقبة SLO/SLI وعمليات الدعم.
* خطة الاستجابة للحوادث (incident response) ودليل استعادة الطوارئ.

**مخرجات:** منصة متاحة للعامة، صفحة توثيق، مركز دعم.

---

### المرحلة 9 — صيانة وتطوير مستمر (Post-launch)

**المدة:** مستمر
**مهام:**

* دعم فني مستمر، تصحيح الأخطاء، تحسين الأداء.
* ميزات جديدة: تلقائيّة التغذية الذكية، تكاملات محاسبية محلية، تقارير ضريبية حسب الدولة.
* تحديثات أمنية دورية، مراجعات اعتماد ISO/GDPR إن لزم.

**مخرجات:** Roadmap مستمر وإصدارات شهرية/ربع سنوية.

---

## 5. خطة الاختبارات التفصيلية

* **اختبارات وحدات (Unit Tests):** تغطية 70%+ للطبقات الحاسوبية.
* **اختبارات تكامل (Integration Tests):** قاعدة بيانات حقيقية، Redis، Message Broker.
* **اختبارات نهاية إلى نهاية (E2E):** باستخدام Playwright أو Cypress للواجهات.
* **اختبارات أمان:** SAST (static scan) + DAST (dynamic scan) + PenTest.
* **اختبارات تحميل/perf:** باستخدام k6 أو JMeter (تحديد سيناريوهات: peak day, sync jobs, IoT burst).
* **اختبارات استعادة البيانات:** محاكاة فقدان DB واستعادة من النسخ الاحتياطي.

---

## 6. الأمن والامتثال

* **هوية ووصول:** OAuth2 + OpenID Connect، MFA اختياري للمستخدمين الإداريين، إدارة جلسات قصيرة المدى، revocation.
* **تشفير:** TLS لجميع الاتصالات، تشفير at-rest لحقول حساسة (بيانات مالية) باستخدام KMS.
* **حماية التطبيقات:** استخدام مكتبات حماية من OWASP، CSP headers، rate-limiting، WAF.
* **سجلات ومراجعة:** Audit logs لكل تغيير محاسبي/مالي، إمكانية تصدير السجلات للفحص القانوني.
* **امتثال:** تصميم النظام ليتوافق مع IFRS، إعداد تقارير داعمة للضرائب المحلية (يتم تطويرها حسب البلد لاحقًا)، احترام لوائح الخصوصية (GDPR) بتوفير حذف بيانات والتوافق مع طلبات المستخدم.

---

## 7. تخطيط فريق العمل والموارد

### فريق أساسي مقترح (مرحلة التنفيذ الأولية)

* Product Owner / Domain Expert (1)
* Project Manager (1)
* Solution Architect (1)
* Backend Developers (2-3)
* Frontend Developers (2)
* Mobile Developer (1)
* DevOps Engineer (1)
* QA Engineers (1-2)
* UX/UI Designer (1)
* Accountant / مستشار محاسبي (1)
* Technical Writer / Documentation (0.5)

### تقدير التكاليف (تقريبي)

* يمكن أن تختلف حسب الموقع والرواتب. احسب تكلفة شهرية تقريبية للفريق الأساسي (10 أشخاص) + Cloud (متوسط): **\$40k - \$80k شهريًا** في المرحلة النشطة، مع انخفاض بعد الإطلاق.

---

## 8. خطة النسخ الاحتياطي والتعافي من الكوارث

* نسخ احتياطي لقاعدة البيانات: نسخ يومية كاملة + لقطات لحظية كل ساعة (WAL archiving).
* نسخ ملفات S3: تخزين متعدد مناطق إذا كانت البيانات حرجة.
* خطة استعادة (RTO): أقل من 2 ساعة للأنظمة الحرجة، RPO: 1 ساعة كحد أقصى.
* اختبارات استعادة نصف سنوية.

---

## 9. التسعير والنموذج التجاري (اقتراح)

* **خطة Freemium:** ميزات أساسية مجانية (حتى X حوض، تقارير محدودة).
* **Basic:** للمزارع الصغيرة (مدفوع شهريًا).
* **Pro:** ميزات محاسبية متقدمة، تقارير BI.
* **Enterprise:** تكوينات مخصصة، فصل قواعد بيانات، SLA أعلى.
* إضافة إيرادات من خدمات: تركيب أجهزة IoT، تدريب، دعم مخصص، ربط مع أنظمة محاسبية محلية.

---

## 10. توثيق وتسليم العميل

* دليل مستخدم بالعربية والإنجليزية.
* وثائق API للمطورين (OpenAPI).
* دليل التشغيل (Runbook) لفريق الدعم.
* ملفات تدريب (فيديوهات قصيرة، Slides، سيناريوهات استخدام).

---

## 11. مؤشرات قياس نجاح المشروع (KPIs)

* وقت الاستجابة للواجهة (avg) < 300ms.
* توافر الخدمة > 99.9%.
* معدل الاحتفاظ بالعملاء بعد 6 أشهر > 80% لخطط Pro.
* متوسط زمن حل الحوادث (MTTR) < 4 ساعات.
* نسبة الأخطاء الحرجة المفتوحة في production < 1%.

---

## 12. قائمة تسليمات نهائية (Checklist قبل Go-Live)

1. SRS موقّعة من العميل.
2. ERD ومواصفات API مكتملة.
3. بيئة production جاهزة مع CI/CD.
4. اختبارات أمان وتحميل مكتملة وتقاريرها.
5. سياسة نسخ احتياطي واسترداد مختبرة.
6. محتوى تدريبي ودليل المستخدم جاهز.
7. خطة تسعير وبوابة دفع مُفعّلة.
8. اتفاقية مستوى الخدمة (SLA) مكتوبة وموقعة.

---

## 13. ملاحظات تنفيذية عملية ونصائح

* ابدأ بنواة (MVP) تركز على وظائف أساسية: إدارة الأحواض، تسجيل القياسات، نظام محاسبي بسيط، وواجهة Dashboard.
* استخدم Feature Flags لفتح/غلق ميزات أثناء النشر.
* وفّر آلية ترحيل بيانات (CSV import) للمزارع القائمة.
* قيّم استخدام تكاملات محلية للدفعات/الفواتير حسب البلد.

---

## 14. أمثلة جداول زمنية إجمالية (تقديري)

* التحليل والتصميم: 5 أسابيع
* إعداد Infra وCI/CD: 3 أسابيع
* تطوير Backend+Frontend+Mobile (MVP): 12 أسبوع
* IoT + BI + اختبارات + Pilot: 8 أسابيع
* إطلاق: 2 أسبوع

**الإجمالي التقريبي:** 30-32 أسبوع (7-8 أشهر) للوصول إلى إصدار كامل جاهز للإنتاج مع Pilot. (يمكن تسريع بعض المهام بالتوازي إذا زادت الموارد).

---

## 15. الخطوة التالية (تسليم فوري)

* إعداد ERD تفصيلي وملف SQL schema.
* واجهات Figma للشاشات الأساسية (Login, Dashboard, Tank Management, Accounting).
* إعداد repo هيكلي (monorepo أو polyrepo) وقوالب الخدمات.

---

## 15.1 تقدم فعلي (Sprint 1 – Backend Core Slice)

تم إنجاز شريحة أولى من الـ Backend تركز على: المصادقة، التعددية (Multi-Tenancy) وعزل الموارد (Farms, Ponds) مع إعداد توثيق Swagger وتحسينات قابلية الاختبار.

### الإنجازات التقنية المكتملة

| المجال | الوضع | ملاحظات |
|--------|-------|---------|
| Auth (JWT) | ✅ | توحيد السر عبر ConfigService + Payload (sub, tenantId, role) |
| Multi-Tenancy Interceptor | ✅ | استخراج X-Tenant-Id وتحويل code → UUID + تعيين GUC لاحقاً للـ Postgres |
| Tenant Isolation في الخدمات | ✅ | تقييد جميع استعلامات farms/ponds بـ tenantId |
| Ponds & Farms CRUD (MVP) | ✅ | إنشاء + استعلام + تحديث + حذف ضمن العزل |
| Events Logging | ✅ | farm.created / pond.created / http_request / swagger.enabled |
| RolesGuard مبدئي | ✅ | دعم @Roles('admin') على بعض المسارات |
| E2E Tests | ✅ | تدفق register → create farm → create pond + اختبارات منع العبور بين التنانت |
| Stats Isolation Test | ✅ | اختبار get /farms/:id/stats يحظر الوصول عبر Tenant آخر |
| Swagger Global Header | ✅ | حقن بارامتر X-Tenant-Id تلقائياً في جميع العمليات |
| README تحديث | ✅ | أمثلة متعددة للمزارع والأحواض مع الهيدر |

### الفجوات المتبقية (ضمن نفس المجال)

| عنصر | الحالة الحالية | الإجراء القادم |
|------|---------------|---------------|
| RBAC تفصيلي | Placeholder RolesGuard | تصميم مصفوفة صلاحيات granular Sprint لاحق |
| Water Quality Module | غير منفذ | ضمن Sprint 2 المقترح |
| Accounting Seed | غير منفذ | لاحق بعد استقرار نطاق الدومين الأساسي |
| Postgres RLS فعلي (Policies) | تصميم مبدئي فقط | تطبيق migrations عند التحول لبيئة Postgres |

### مؤشرات سريعة

* جميع اختبارات E2E ذات الصلة تمر (Isolation ✅).
* لا تسريبات cross-tenant مكتشفة في الحالات المغطاة بالاختبارات.
* واجهة Swagger (/docs) مفعّلة محلياً (NODE_ENV != production) وتحقن الهيدر عالمياً.

---

---

### ملاحظة أخيرة

تم تصميم هذه الخطة لتكون شاملة وقابلة للتنفيذ خطوة بخطوة. إذا رغبت، يمكنني الآن توليد: ERD مفصل + SQL schema ابتدائي + نموذج API (OpenAPI) + صفحات Figma مبدئية. حدد ما ترغب أن أبدأ به فوراً.

---

## 16. إضافة: تحليلات الذكاء الاصطناعي (AI Analytics)

> هذا القسم يوضح كيف يتم دمج قدرات الذكاء الاصطناعي داخل المنصة لرفع قيمة المنتج، دعم اتخاذ القرار، وتقليل التكاليف التشغيلية للمزارع.

### 16.1 حالات استخدام أساسية (Use Cases)

1. **التنبؤ بنمو الأسماك والوزن المتوسط**: نماذج توقّع وزن السمك على مدار الزمن لكل دورة إنتاج بناءً على بيانات التغذية وجودة المياه والطقس.
2. **التنبؤ بمعدلات النفوق (Mortality Prediction)**: كشف الحالات المرتفعة الخطورة قبل وقوعها بناءً على أنماط القياسات وبيانات التاريخ.
3. **تحسين جرعات الأعلاف (Feed Optimization)**: توصيات ديناميكية لكمية ونوع العلف لتقليل التكلفة لكل كيلو وزن مكتسب.
4. **كشف الشذوذ/الإنذارات المبكرة (Anomaly Detection)**: اكتشاف قراءات جودة مياه غير طبيعية أو سلوك أجهزة IoT.
5. **التصنيف التلقائي للفواتير/القيود المحاسبية**: استخدام NLP لتصنيف الفواتير ووضع القيود المحاسبية تلقائياً (OCR + NLP).
6. **تحليل الربحية والتكلفة لكل دورة/حوض**: تحليل العوامل المؤثرة في الربحية واقتراح تحسّنات تشغيلية.
7. **التنبؤ بالطلب والجدولة البيعية**: توقع أحجام البيع لتخطيط الحصاد والتسويق.
8. **مساعد ذكي تفاعلي داخل التطبيق**: واجهة دردشة للإجابة عن أسئلة المشغلين وإعطاء توصيات فورية.

### 16.2 البنية التقنية لبايبلاين الذكاء الاصطناعي

* **مصادر البيانات:** قواعد بيانات PostgreSQL، بيانات IoT (MQTT/HTTPS)، سجلات العمليات، ملفات CSV المستوردة، صور/صور المزارع (إن وجدت).
* **ETL / Ingestion:** بيانات تُنقَى وتُوحَّد عبر Batch jobs (Airflow) وStream ingestion (Kafka) لقراءات الوقت الحقيقي.
* **Feature Store:** تخزين الميزات المحسوبة (weights, feed\_per\_fish, rolling\_avg\_ph) للوصول السريع أثناء التدريب والتنبؤ.
* **Training Layer:** منصات تدريب على GPU (on-premise أو cloud: AWS SageMaker / GCP Vertex / Azure ML).
* **Model Registry & MLOps:** MLflow أو Kubeflow لتتبع النماذج، النسخ، والـ CI/CD للنماذج.
* **Serving:** خدّمية للنماذج (KFServing, TorchServe, FastAPI + Docker) تدعم التنبؤات عبر REST/GRPC.
* **Monitoring:** مراقبة أداء النماذج (drift, skew), logging، وalerts على تدهور الدقة.

### 16.3 أنواع النماذج المقترحة

* **Time-series forecasting:** Prophet, LSTM, TCN, Transformer-based models (Temporal Fusion Transformer) للتنبؤ بالوزن والنمو.
* **Tree-based models:** XGBoost/LightGBM لميزات مُجمَّعة وقرارات سريعة في التنبؤ بالنفوق وأحداث الحرجة.
* **Anomaly detection:** Isolation Forest, Autoencoders, One-Class SVM للقراءات الحسية.
* **NLP / OCR:** Tesseract أو خدمات OCR سحابية مع نماذج Transformer (BERT عربي/إنجليزي) لتصنيف الفواتير ووضع القيود المحاسبية.
* **Reinforcement Learning (مستقبلي):** لتحسين سياسات التغذية ضمن بيئات محاكاة لتقليل التكاليف وزيادة الإنتاج.

### 16.4 متطلبات البيانات والحوكمة

* **جودة البيانات:** سياسات تنظيف، التعامل مع القيم المفقودة، وعمليات الإثراء (enrichment).
* **تصنيف البيانات:** تعليم الحقول الحساسة (PII, Financial) وتشفيرها عند التخزين.
* **التوافق والخصوصية:** الامتثال لالتزامات الخصوصية (GDPR) وخيارات مشاركة/عدم مشاركة البيانات بين Tenants.
* **إدارة تسمية البيانات (Labeling):** أدوات labeling داخلية أو عبر منصات (Labelbox) لجمع بيانات تدريب مصنفة (مثلاً: حالات نفوق، أسباب نفوق).

### 16.5 تصميم واجهات ونقاط التكامل (APIs)

* **Endpoints رئيسية مقترحة:**

  * `POST /api/v1/ai/predict/growth` — توقع الوزن المستقبلي لحوض أو دورة.
  * `POST /api/v1/ai/predict/mortality` — احتمال النفوق خلال N أيام.
  * `GET /api/v1/ai/recommendations/feed` — توصية جرعات الأعلاف.
  * `POST /api/v1/ai/anomaly` — إرسال دفعات قراءات للتحقق من الشذوذ.
  * `POST /api/v1/ai/ocr/invoice` — استخراج وتصنيف الفواتير.

> كل استدعاء يتطلب مصادقة JWT وحقل `tenant_id` لضمان العزل.

### 16.6 قابلية التطبيق (Online vs Batch)

* **Batch jobs:** تقارير يومية/أسبوعية (growth forecasting, profitability analysis) — مناسبة للتشغيل المجدول عبر Airflow.
* **Online serving:** تنبيهات آنية (anomaly detection) وتوصيات التغذية — عبر موديل خدمة منخفض زمن استجابة (<200ms).

### 16.7 قابلية الشرح والشفافية (Explainability)

* استخدام أدوات مثل SHAP/Integrated Gradients لشرح قرارات النماذج خاصة للمخرجات المحاسبية أو التنبؤية الهامة.
* تقديم واجهة تعرض السمات الأكثر تأثيرًا في كل تنبؤ (مثلاً: "الارتفاع الأخير في الأمونيا زاد من احتمال النفوق بنسبة 12%")، باللغة العربية والإنجليزية.

### 16.8 مراقبة الأداء وصيانة النماذج

* تتبع مؤشرات: accuracy, RMSE, MAE, AUC حسب الحالة.
* كشف تحوّل التوزيع (data drift) وتنبيه عندما تنخفض الدقة عن عتبة محددة.
* سياسة إعادة تدريب: إعادة تدريب دوري (مثلاً كل 2-4 أسابيع) أو عند اكتشاف drift.

### 16.9 متطلبات البنية التحتية والميزانية التقريبية

* **بيئة تدريب:** GPU (NVIDIA T4/P100/V100) حسب حجم البيانات؛ يُنصح بالبدء بـ 1-2 GPU سحابي للتجريب.
* **تقنيات MLOps:** MLflow (OSS) + S3 (artifact store) + Postgres / Feature Store (Feast اختياري).
* **تكلفة تقريبية مبدئية:** \$1k - \$5k شهريًا في السحابة لمراحل التطوير والتجريب، وتزيد حسب حجم البيانات وكمية نماذج الإنتاج.

### 16.10 فريق ومسؤوليات AI

* Data Scientist / ML Engineer (1-2)
* ML Ops Engineer (1)
* Data Engineer (1)
* Domain Expert / Aquaculture Specialist (1)
* Backend Engineer لربط النماذج بالـ APIs (1)

### 16.11 خارطة طريق تنفيذـية مقترحة (Milestones) — 12 أسبوع مبدئياً

1. **أسبوع 1-2:** جمع البيانات، تحليل جودتها، تحديد حالات الاستخدام ذات الأولوية (growth, mortality).
2. **أسبوع 3-4:** بناء ETL وFeature Store، تجارب نماذج أولية (baseline models).
3. **أسبوع 5-6:** تجهيز MLOps (MLflow), تسجيل النماذج، ونمذجة الأداء (validation).
4. **أسبوع 7-8:** نشر نماذج Serving (batch + online), إعداد API endpoints.
5. **أسبوع 9-10:** التكامل بالواجهة، تقارير الشرح (SHAP)، واختبارات A/B مع عملاء Pilot.
6. **أسبوع 11-12:** مراقبة الإنتاج، تحسينات، وثائق التشغيل وتدريب المستخدمين.

### 16.12 اعتبارات قانونية وأخلاقية

* موافقة Tenants على استخدام بياناتهم في التدريب (إما مشفوعة أو مجهولة/مجمعة).
* توفير خيار عدم مشاركة البيانات (opt-out) أو مشاركة مجمعة فقط.
* توثيق قرارات النماذج في السجلات لأغراض تدقيق المحاسبة.

---

**تمت إضافة هذا القسم إلى ملف الخطة.**

*إذا رغبت، أستطيع الآن:*

*1. توليد نموذج API عملي (OpenAPI) لنقاط النهاية أعلاه.
*2. إنشاء مسودات سكربتات ETL وملفات إعداد MLOps (MLflow, Dockerfile, deployment manifests).
*3. بناء PoC صغير (كود تدريب نموذجي + endpoint serving) باستخدام بيانات تجريبية افتراضية.

اختر رقم أو أكثر لأبدأ التنفيذ فورًا.

---

## 17. إضافة: القوانين والأنظمة العربية في المحاسبة

> لضمان توافق النظام مع البيئات العربية يجب مراعاة الأنظمة والتشريعات المحلية للمحاسبة، بجانب المعايير الدولية (IFRS). فيما يلي خطة إدماج هذه المتطلبات.

### 17.1 المعايير والأنظمة العربية المستهدفة

* **المملكة العربية السعودية:** نظام ضريبة القيمة المضافة (VAT 15%)، الزكاة، متطلبات هيئة الزكاة والضريبة والجمارك (ZATCA).
* **مصر:** قانون الضريبة على القيمة المضافة، قانون الضرائب على الدخل، الفاتورة الإلكترونية (e-invoicing).
* **الإمارات:** ضريبة القيمة المضافة (VAT 5%)، متطلبات الهيئة الاتحادية للضرائب (FTA).
* **السودان:** ضرائب القيمة المضافة، القوانين المحلية للإعفاءات الزراعية.
* **دول أخرى:** الامتثال للأنظمة الضريبية المحلية وتحديثها المستمر.

### 17.2 التوافق مع الأنظمة الضريبية

يستلزم النظام طبقة إعداد ضريبي (Tax Configuration Layer) قابلة للتخصيص لكل Tenant مع دعم القواعد المشتركة افتراضيًا وإعادة تعريف محلية. العناصر الأساسية:

| عنصر | وصف | قابلية التهيئة |
|-------|-----|-----------------|
| VAT Rates | نسب ضريبة القيمة المضافة (5%, 15%, 0%, معفي) | لكل دولة / Tenant |
| Withholding Tax | استقطاع عند المصدر لبعض أنواع المدفوعات | لكل دولة |
| Zakat (السعودية) | حساب الزكاة على رأس المال/الوعاء الزكوي | تمكين / تعطيل + معادلات |
| E-Invoice Profile | شكل الفاتورة الإلكترونية (حقل QR, UUID, Signing) | لكل دولة |
| Rounding Rules | سياسة التقريب (نكسة/أقرب/لأعلى) | لكل عملة |
| Tax Exempt Codes | رموز الإعفاء / الأساس القانوني | قاموس محلي |

### 17.3 طبقة المحرك الضريبي (Tax Engine Layer)

مكوّن منفصل (module) يقوم بـ:

1. تحليل سطور الفاتورة (Lines) وتحديد معدل الضريبة بناءً على: نوع السلعة، جهة التوريد، الدولة، تاريخ السريان.
2. دعم قواعد تاريخية (Effective Date) لتغيّر معدلات الضريبة.
3. إرجاع تفاصيل ضريبية مفصّلة: (Base Amount, Tax Rate, Tax Amount, ExemptionReason, TaxCode).
4. توليد تجميع (Tax Summary) للفواتير والتقارير (VAT Return / إقرار ضريبي).
5. توفير API داخلي: `calculateInvoiceTax(draftInvoiceDto) => TaxComputationResult`.

### 17.4 الفوترة الإلكترونية (E-Invoicing) — متطلبات مختارة

| دولة | متطلبات رئيسية | تبعات تقنية |
|------|----------------|-------------|
| السعودية (ZATCA) | TLV QR, UUID, توقيع رقمي، فترة مرحلة | مكتبة توليد TLV + مفاتيح توقيع + تخزين Hash |
| مصر | بوابة EGS, Token OAuth, إرسال XML/JSON | موصل (Connector) + Queue للـ retry |
| الإمارات | فاتورة ضريبية قياسية (لا زال بسيط) | تنسيق PDF/HTML + أرقام تسلسلية |
| دول أخرى | لاحقاً | تصميم واجهة Plug-in |

مراحل التنفيذ المقترحة للفوترة الإلكترونية:

1. طبقة تجريد (Adapter Interface).
2. موصل ZATCA (Sandbox) + اختبارات.
3. موصل EGS (مصر) + إدارة الرموز (Token Rotation).
4. إدراج حالة التدفق ضمن Workflow (Draft -> Approved -> Reported -> Acknowledged).

### 17.5 مخطط الحسابات (Chart of Accounts) المحلي

نهج: قالب IFRS أساسي + Overlays لكل دولة:

* السعودية: حسابات الزكاة، الاحتياطي النظامي.
* مصر: حسابات الضرائب المؤجلة، فروق العملة.
* الإمارات: بساطة أعلى (IFRS مباشر).

تنفيذ: جدول `chart_templates` + جدول `tenant_chart_accounts` (يولد من القالب + يسمح بالتخصيص المحدود).

### 17.6 العملات المتعددة والتقييم (Multi-Currency)

* تخزين جميع السجلات بالقيمة المحلية + عملة عرض (reporting currency) إذا تم تمكينها.
* جدول أسعار صرف يومي (FX Rates) مع مصدر (ECB / OpenExchange / Manual).
* توليد قيود فروق العملة (Unrealized / Realized FX) نهاية الفترة.

### 17.7 القيود المحاسبية التلقائية (Auto Posting Rules)

| حدث | قيود أساسية | ملاحظات |
|-----|-------------|---------|
| شراء أعلاف | Debit Inventory / Credit Accounts Payable | تطبيق الضريبة المدخلة |
| استهلاك أعلاف | Debit COGS / Credit Inventory | Batch Job / مباشر |
| نفوق | Debit Loss Account / Credit Inventory / Biological Assets | يعتمد على سياسات تقييم |
| بيع منتجات (Harvest) | Debit Accounts Receivable / Credit Revenue + VAT Output | عند إصدار فاتورة |
| تحصيل | Debit Cash / Credit Accounts Receivable | دعم اختلاف العملة |

### 17.8 التدقيق والأثر (Audit & Traceability)

* كل قيد JournalEntry له: `source_module`, `source_reference`, `hash_chain_prev` (ربط تجزئي لتسهيل كشف العبث).
* قفل الفترات المالية بعد الإقفال (Period Lock) مع سجل فتح/إغلاق.
* Export تدقيقي (JSON + CSV) باسم توقيع Hash.

### 17.9 التقارير الدورية

* تقرير ضريبة القيمة المضافة (ملخّص Tax Codes + صافي مستحق).
* تقرير زكاة (معادلة وعاء + صافي زكاة مقترحة).
* تحليل تكلفة الإنتاج لكل كيلو (تجميع أعلاف + نفوق + خدمات تشغيلية / إجمالي وزن محقق).

### 17.10 خطة طرح تدريجي للمحاسبة المحلية

| مرحلة | نطاق | هدف الاعتماد |
|--------|------|--------------|
| A | IFRS عام + VAT أساسي | Merged في بيئة Staging |
| B | ZATCA (QR + توقيع) | Pilot عميل سعودي |
| C | EGS Egypt Connector | Pilot عميل مصري |
| D | Multi-Currency + FX | إطلاق عام محاسبي متقدم |
| E | تقارير زكاة + ضرائب موسعة | الامتثال المتكامل |

### 17.11 مخاطر وتخفيف

| خطر | الأثر | الإجراء الوقائي |
|------|-------|-----------------|
| تغيّر تشريعات فجائي | إعادة عمل / تأخير | تصميم Rules قابلة للتحديث عبر DB |
| تأخير موصل E-Invoice | تعطيل الإطلاق في دولة | اعتماد Manual Export مؤقت |
| أخطاء احتساب VAT | التزامات قانونية | اختبارات وحدة + اختبارات ملكية (Property-based) |
| عدم دقة أسعار الصرف | فروق تقييم خاطئة | مصدرين + آلية مصادقة Manual Override |

### 17.12 مؤشرات نجاح المحاسبة المحلية

* نسبة الفواتير المقبولة بدون رفض في القنوات الرسمية > 98%.
* زمن احتساب فاتورة (Server) < 120ms.
* زمن إغلاق فترة شهرية بعد نهاية الشهر < 2 يوم عمل.

### 17.13 المهام الفورية (Next Immediate Accounting Tasks)

1. تصميم جداول: `tax_profiles`, `tax_rates`, `invoice_series`, `e_invoice_submissions`.
2. رسم مخطط Posting Engine (State Diagram) للفوترة.
3. توليد Migration أولي للحسابات الأساسية (Chart Template).
4. كتابة وحدة اختبار Property-based لحساب VAT (مدى معدلات 0–20%).
5. PoC لتوليد TLV QR (ZATCA) + تخزين التوقيع.

---

## 18. خارطة ربط (Mapping) بين الـ Roadmap العام والتنفيذ الحالي

| مجال | الوضع الحالي | المرحلة المخططة التالية | فجوة رئيسية |
|------|-------------|--------------------------|-------------|
| OpenAPI Core | ✅ (0.2.0) | إثراء Examples & Error Codes | توحيد أكواد أخطاء عملانية |
| Multi-Tenancy | ✅ أساسيات | تطبيق RLS فعلي | سياسة row security |
| Water Quality | قيد الإضافة (Spec جاهز) | Implement Service + Trends Logic | خوارزميات التحليل |
| Accounting | مبدئي (Journal Entry Stub) | بناء Tax Engine | تصميم CoA محلي |
| IoT Ingestion | غير منفذ | بوابة MQTT/HTTPS | أمان الجهاز |
| AI Analytics | موثق فقط | تحديد Data Contracts | جودة البيانات |
| E-Invoicing | غير منفذ | Adapter Interface | توقيع رقمي |
| Mobile Offline | غير منفذ | Sync Strategy Draft | تضارب البيانات |

## 19. مصفوفة مخاطر شاملة (Expanded Risk Matrix)

| التصنيف | الخطر | الاحتمال | الأثر | أولوية | خطة استباقية | خطة طوارئ |
|---------|-------|----------|-------|--------|--------------|-------------|
| تقني | فشل اعتماد RLS | متوسط | عالي | مرتفع | اختبار مبكر + Audit Logging | fallback فلترة تطبيقية |
| تقني | اختناق PostgreSQL (I/O) | منخفض | عالي | متوسط | فهارس + مراقبة | Sharding / Read Replicas |
| أمان | تسرب مفتاح توقيع E-Invoice | منخفض | حرج | مرتفع | HSM/KMS + Rotation | إبطال فوري + إعادة إصدار |
| امتثال | خطأ VAT جماعي | منخفض | عالي | مرتفع | Property Tests + مراجعة محاسب | تصحيح رجعي + إبلاغ عملاء |
| أدائي | حمل قراءات IoT Burst | متوسط | متوسط | متوسط | Buffer + Queue | تقليص معدل المعالجة |
| منتج | تعقيد واجهة المستخدم | متوسط | متوسط | متوسط | اختبارات UX مبكرة | تحسين سريع Iteration |
| بيانات | Drift نماذج AI | متوسط | متوسط | متوسط | مراقبة Metrics | إعادة تدريب طارئ |

## 20. قائمة تنفيذ سريعة (Actionable Sprint Backlog Extract)

| رقم | المهمة | التصنيف | الجهد (نسبي) | اعتماد سابق |
|-----|--------|---------|--------------|--------------|
| 1 | Implement WaterQualityService (CRUD + Trends stub) | Backend | 5 | OpenAPI جاهز |
| 2 | إضافة Migration CoA أساسي | Accounting | 3 | تصميم جدول |
| 3 | إنشاء tax_rates & tax_profiles migrations | Accounting | 2 | 2 |
| 4 | PoC TLV QR ZATCA (Script) | Accounting/Compliance | 3 | 3 |
| 5 | إعداد RLS Policies (Farms, Ponds) | Security/Data | 5 | Multi-Tenancy جاهز |
| 6 | إعداد Feature Flag Service | Platform | 2 | Core Config |
| 7 | إضافة Unified Error Codes (ENUM) في Backend | Backend | 2 | ErrorResponse |
| 8 | إعداد basic Device Registration Endpoint | IoT | 3 | Auth |
| 9 | إعداد جدول fx_rates + sync job | Accounting | 4 | CoA |
| 10 | Draft Sync Strategy للموبايل (وثيقة) | Mobile | 2 | لا شيء |

ملاحظة: الجهد (1-5) تقديري نسبي للسبرنت (5 أعلى).

## 21. الخطوة الختامية الحالية

تم استكمال توسيع خارطة الطريق بإضافة تفاصيل الامتثال المحاسبي الإقليمي، خطة المحرك الضريبي، مراحل التدرج، والمخاطر مع باك-لوج عملي. يمكن البدء فورًا بتنفيذ البنود 1–3 و7 ضمن Sprint قريب لتسريع القيمة المحققة.

إذا رغبت، أستطيع الآن إنتاج:

1. مخطط قاعدة بيانات (SQL) للجداول: tax_profiles, tax_rates, invoice_series, fx_rates.
2. Migration TypeORM أولي لهذه الجداول.
3. Draft WaterQualityService + Module في Backend.

حدد اختيارك لأتابع.
